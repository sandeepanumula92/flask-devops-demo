name: Build and Push Docker Image

on:
  push:
    branches: [ "main" ]

# 1. (Optional) General Permissions: 
# You can leave this out if you set the repository default to "Read and write permissions" 
# in the Settings > Actions > General tab, but it does no harm to keep it here.
permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 2. CRITICAL FIX: Explicitly set permissions at the job level.
    # This guarantees the GITHUB_TOKEN has the 'write' scope for packages.
    permissions:
      contents: read
      packages: write 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 3. Log in to GHCR
      # Uses github.actor (the user who triggered the workflow) and 
      # the built-in GITHUB_TOKEN for authentication.
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      # 4. Build and push image
      # 'context' defaults to '.', which is the root of the checked-out repository.
      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/flask-demo:latest
          # Example of an additional tag for versioning:
          # tags: ghcr.io/${{ github.repository_owner }}/flask-demo:${{ github.sha }}
